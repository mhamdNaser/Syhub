{% assign cart_text = settings.empty_cart_text | default: 'Your cart is empty.' %}
{% assign enable_cart_drawer_undo_remove = settings.enable_cart_drawer_undo_remove | default: false %}
{% assign enable_cart_drawer_undo_remove_delay = settings.enable_cart_drawer_undo_remove_delay | default: false %}
{% assign cart_drawer_undo_remove_delay = settings.cart_drawer_undo_remove_delay | default: 5 %}

{% if cart and cart.item_count > 0 %}
<div class="p-4 bg-gray-50 min-h-screen"
     x-data="cartHandler({
        enableUndo: {{ enable_cart_drawer_undo_remove }},
        enableDelay: {{ enable_cart_drawer_undo_remove_delay }},
        delay: {{ cart_drawer_undo_remove_delay }}
     })">

  <div class="max-w-6xl mx-auto bg-white rounded-lg shadow-lg p-6">

    <!-- Page Title -->
    <div class="flex flex-col md:flex-row items-center justify-between mb-6">
      <h1 class="text-3xl font-bold text-gray-800">üõí Your Shopping Cart</h1>
      <a href="{{ routes.all_products_collection_url }}" class="text-blue-600 hover:underline">
        ‚Üê Continue Shopping
      </a>
    </div>

    <!-- Trust Bar -->
    <div class="bg-green-50 border border-green-200 text-green-800 p-3 rounded-md text-center mb-6">
      üîí 100% Secure Checkout | üöö Fast Shipping | üí≥ Multiple Payment Methods
    </div>

    <!-- Undo Remove Bar -->
    <div x-show="showUndo" 
         x-transition 
         class="bg-gray-800 text-white p-4 rounded shadow-lg mb-6 flex items-center">
      Product removed
      <button @click="undoRemove" class="text-white px-2 py-1 ml-2 rounded">Undo</button>
      <span class="ml-2 text-sm text-gray-300" x-text="`(${countdown}s)`"></span>
    </div>

    <!-- Cart Form -->
    <form action="/cart" method="post" novalidate class="space-y-10">
      <div class="overflow-x-auto mb-8">
        <table class="w-full border-collapse border border-gray-200 rounded-lg overflow-hidden">
          <thead class="bg-gray-800 text-white">
            <tr>
              <th class="p-4 text-left">Product</th>
              <th class="p-4 text-left">Price</th>
              <th class="p-4 text-left">Quantity</th>
              <th class="p-4 text-left">Total</th>
              <th class="p-4 text-left">Action</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cart.items %}
            <tr class="border-b hover:bg-gray-50">
              <td class="p-4 flex items-center gap-4">
                <a href="{{ item.url }}">
                  {% if item.image %}
                  <img src="{{ item.image | image_url: width: 100 }}" alt="{{ item.title }}" class="w-16 h-16 object-cover rounded" width="auto" height="auto">
                  {% else %}
                  {{ 'product-1' | placeholder_svg_tag: 'w-16 h-16 object-cover rounded' }}
                  {% endif %}
                </a>
                <div>
                  <a href="{{ item.url }}" class="font-semibold text-gray-800 hover:text-blue-600">{{ item.product.title }}</a>
                  <p class="text-sm text-gray-500">{{ item.variant.title }}</p>
                </div>
              </td>
              <td class="p-4">{{ item.price | money }}</td>
              <td class="p-4">
                <input type="number" name="updates[]" value="{{ item.quantity }}" min="1" class="w-16 border rounded text-center">
              </td>
              <td class="p-4 font-semibold">{{ item.line_price | money }}</td>
              <td class="p-4">
                <a href="#"
                   class="text-red-500 hover:underline"
                   @click.prevent="removeItem('{{ forloop.index }}')">
                  üóë Remove
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Checkout Summary -->
      <div class="flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-lg font-semibold">
          Total: <span class="text-blue-600">{{ cart.total_price | money }}</span>
        </div>
        <button type="submit" name="checkout" class="font-semibold py-2 px-6 rounded-lg">
          Proceed to Checkout ‚Üí
        </button>
      </div>
    </form>

    <!-- Product Recommendations -->
    <div class="mt-10">
      <h2 class="text-xl font-bold mb-4">You May Also Like</h2>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        {% for product in collections['frontpage'].products limit:4 %}
        <a href="{{ product.url }}" class="border rounded-lg p-3 hover:shadow-lg transition">
          <img src="{{ product.featured_image | image_url: width: 300 }}" alt="{{ product.title }}" class="w-full h-40 object-cover rounded"  width="auto" height="auto">
          <p class="mt-2 text-sm font-semibold text-gray-800">{{ product.title }}</p>
          <span class="text-blue-600">{{ product.price | money }}</span>
        </a>
        {% endfor %}
      </div>
    </div>

  </div>
</div>
{% else %}
<div class="max-w-6xl min-h-screen flex mx-auto items-center justify-center">
  <div class="text-center">
    <h1 class="text-3xl my-4">{{ cart_text }}</h1>
    <a href="{{ routes.all_products_collection_url }}" class="border border-gray-600 text-white bg-gray-600 px-8 py-3">
      Continue Shopping
    </a>
  </div>
</div>
{% endif %}

<!-- Alpine.js Component -->
<script>
  function cartHandler({ enableUndo, enableDelay, delay }) {
    return {
      showUndo: false,
      countdown: 0,
      removedItem: null,
      timer: null,

      removeItem(line) {
        if (enableUndo) {
          this.removedItem = line;
          this.showUndo = true;
          this.countdown = enableDelay ? delay : 5;

          this.timer = setInterval(() => {
            this.countdown--;
            if (this.countdown <= 0) {
              clearInterval(this.timer);
              this.finalizeRemove();
            }
          }, 1000);
        } else {
          this.finalizeRemove(line);
        }
      },

      undoRemove() {
        clearInterval(this.timer);
        this.showUndo = false;
        this.removedItem = null;
      },

      finalizeRemove() {
        if (this.removedItem) {
          window.location.href = `/cart/change?line=${this.removedItem}&quantity=0`;
        }
      }
    }
  }
</script>
